<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VideoShot</title>

    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <style>
      :root{
        --cream: #FFF6E6;
        --ink: #1F2A37;

        --yellow: #FFD23D;
        --yellow2: #FFE37A;
        --red: #E43D30;
        --blue: #1F5BFF;
        --blue2: #4B7BFF;
        --green: #22C55E;
        --shadow: 0 16px 40px rgba(20, 30, 50, 0.12);
      }
      *{box-sizing:border-box}
      body{
        margin:0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color:var(--ink);
        background:
          radial-gradient(1200px 600px at 10% 5%, rgba(255,210,61,.35), transparent 55%),
          radial-gradient(1000px 600px at 90% 0%, rgba(31,91,255,.22), transparent 55%),
          radial-gradient(900px 600px at 80% 90%, rgba(34,197,94,.18), transparent 55%),
          var(--cream);
        min-height:100vh;
      }
      .topbar{
        position: sticky; top: 0; z-index: 50;
        backdrop-filter: blur(10px);
        background: rgba(255, 246, 230, 0.75);
        border-bottom: 4px solid rgba(31,91,255,.12);
      }
      .topbar-inner{
        max-width: 1040px; margin: 0 auto; padding: 14px 16px;
        display:flex; align-items:center; gap: 12px;
      }
      .brand{display:flex; align-items:center; gap:12px; flex:1; min-width:0;}
      .badge{
        width:44px; height:44px; border-radius: 14px;
        background: linear-gradient(145deg, var(--yellow), var(--yellow2));
        box-shadow: 0 10px 18px rgba(228,61,48,.14);
        display:grid; place-items:center;
        border: 3px solid rgba(228,61,48,.35);
        flex:0 0 auto;
      }
      .title{display:flex; flex-direction:column; line-height:1.05; min-width:0;}
      .title h1{margin:0; font-size:20px; letter-spacing:.2px;}
      .title p{margin:3px 0 0; font-size:13px; opacity:.75; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
      .gear-btn{
        border:0; cursor:pointer; padding: 10px 12px; border-radius: 14px;
        background: linear-gradient(145deg, #fff, #fff7);
        box-shadow: 0 10px 18px rgba(31,91,255,.10);
        border: 2px solid rgba(31,91,255,.16);
        display:flex; align-items:center; gap:8px; font-weight:700;
      }
      .wrap{max-width: 1040px; margin: 0 auto; padding: 18px 16px 40px;}
      .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap: 16px;}
      @media (max-width: 900px){ .grid{grid-template-columns: 1fr;} }
      .card{
        background: rgba(255,255,255,0.92);
        border-radius: 22px;
        box-shadow: var(--shadow);
        border: 3px solid rgba(0,0,0,0.04);
        overflow:hidden;
      }
      .head{
        padding: 14px 16px;
        display:flex; align-items:center; justify-content:space-between; gap:12px;
        background: linear-gradient(90deg, rgba(255,210,61,.35), rgba(31,91,255,.18), rgba(34,197,94,.18));
        border-bottom: 3px dashed rgba(0,0,0,.08);
      }
      .pill{
        display:inline-flex; align-items:center; gap:8px;
        padding: 8px 12px; border-radius:999px;
        background: rgba(255,255,255,0.75);
        border: 2px solid rgba(0,0,0,0.06);
        font-weight:800; font-size:13px;
      }
      .content{padding:16px;}
      .drop{
        border-radius:18px;
        border: 3px dashed rgba(31,91,255,.25);
        background: rgba(255,255,255,0.65);
        padding:14px;
        display:flex; flex-direction:column; gap:10px;
      }
      .file-row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
      .btn{
        border:0; cursor:pointer; padding:12px 14px; border-radius:16px;
        font-weight:900; letter-spacing:.2px;
        background: linear-gradient(145deg, var(--blue), var(--blue2));
        color:#fff;
        box-shadow: 0 14px 22px rgba(31,91,255,.18);
        display:inline-flex; align-items:center; gap:10px;
      }
      .btn.secondary{
        background: linear-gradient(145deg, #fff, #fff);
        color: var(--ink);
        border: 2px solid rgba(0,0,0,.08);
        box-shadow: 0 12px 18px rgba(0,0,0,.06);
      }
      .btn.danger{background: linear-gradient(145deg, var(--red), #ff6b60);}
      input[type="file"]{display:none}
      .kv{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;}
      .box{
        border-radius:18px; padding:12px; background:#fff;
        border: 3px solid rgba(0,0,0,0.04);
        position:relative; overflow:hidden;
      }
      .box::before{
        content:""; position:absolute; inset:-2px; border-radius:18px; padding:3px;
        background: linear-gradient(90deg, var(--yellow), var(--red), var(--blue), var(--green), var(--yellow));
        -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude;
        pointer-events:none; opacity:.55;
      }
      .k{font-size:12px; opacity:.7; font-weight:800}
      .v{font-size:16px; font-weight:950; margin-top:4px}
      .status{
        margin-top:12px; border-radius:18px; padding:12px;
        background: rgba(255,255,255,0.72);
        border: 2px solid rgba(0,0,0,0.06);
        display:flex; align-items:flex-start; gap:10px;
      }
      .dot{
        width:12px; height:12px; border-radius:999px; margin-top:4px;
        background: var(--green); box-shadow: 0 0 0 6px rgba(34,197,94,.18);
      }
      .results-head{
        display:flex; align-items:center; justify-content:space-between;
        gap:10px; flex-wrap:wrap; margin-top:12px;
      }
      .results-head h2{margin:0; font-size:22px;}
      .actions{display:flex; gap:10px; flex-wrap:wrap;}
      .gallery{
        margin-top:12px;
        display:grid; grid-template-columns: repeat(2, minmax(0, 1fr));
        gap:12px;
      }
      @media (max-width: 600px){ .gallery{grid-template-columns: 1fr;} }
      .shot{
        background:#fff; border-radius:22px;
        border: 4px solid rgba(0,0,0,0.04);
        box-shadow: 0 16px 34px rgba(0,0,0,.10);
        overflow:hidden; position:relative;
      }
      .shot::before{
        content:""; position:absolute; inset:0; pointer-events:none;
        border-radius:22px; padding:4px;
        background: linear-gradient(135deg, var(--yellow), var(--red), var(--blue), var(--green), var(--yellow));
        -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude;
        opacity:.85;
      }
      .shot img{width:100%; display:block; background:#000;}
      .meta{
        padding:10px 12px;
        display:flex; justify-content:space-between; align-items:center; gap:10px;
        border-top: 3px dashed rgba(0,0,0,0.08);
        background: rgba(255,246,230,0.55);
      }
      .tag{
        display:inline-flex; align-items:center; gap:8px;
        font-weight:950; padding:8px 10px; border-radius:999px;
        background: rgba(255,255,255,0.85);
        border: 2px solid rgba(0,0,0,0.06);
      }
      .small{font-size:12px; opacity:.75; font-weight:800;}
      .modal{
        position:fixed; inset:0; background: rgba(0,0,0,0.65);
        display:none; z-index:1000; padding:18px;
      }
      .modal.open{display:block}
      .panel{
        max-width:980px; margin:0 auto; background:#fff;
        border-radius:24px; overflow:hidden;
        box-shadow: 0 24px 60px rgba(0,0,0,.25);
        border: 4px solid rgba(255,210,61,.35);
      }
      .mhead{
        display:flex; align-items:center; justify-content:space-between;
        padding:12px 14px;
        background: linear-gradient(90deg, rgba(31,91,255,.15), rgba(255,210,61,.35));
        border-bottom: 3px dashed rgba(0,0,0,.12);
      }
      .mhead h3{margin:0; font-size:16px}
      .body{padding:12px;}
      .carousel{
        display:flex; gap:10px; overflow:auto;
        scroll-snap-type:x mandatory; padding-bottom:6px;
      }
      .item{
        min-width:75%; scroll-snap-align:center;
        border-radius:20px; overflow:hidden;
        border: 4px solid rgba(0,0,0,0.05);
        box-shadow: 0 16px 28px rgba(0,0,0,.12);
      }
      .item img{width:100%; display:block; background:#000;}
      .settings{
        display:none; margin-top:12px; padding:12px; border-radius:18px;
        background: rgba(255,255,255,0.72);
        border: 2px solid rgba(0,0,0,0.06);
      }
      .settings.open{display:block}
      .row{
        display:flex; align-items:center; justify-content:space-between;
        gap:12px; flex-wrap:wrap;
      }
      .row label{font-weight:950;}
      .row input[type="range"]{width:240px;}
      .hint{font-size:12px; opacity:.75; font-weight:800; margin-top:8px;}
      .footer{padding:22px 16px; text-align:center; font-size:12px; opacity:.72; font-weight:800;}
    </style>
  </head>

  <body>
    <div class="topbar">
      <div class="topbar-inner">
        <div class="brand">
          <div class="badge" aria-hidden="true">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M9 5.5 10.3 4h3.4L15 5.5h2.2A3.8 3.8 0 0 1 21 9.3v7.4A3.8 3.8 0 0 1 17.2 20.5H6.8A3.8 3.8 0 0 1 3 16.7V9.3A3.8 3.8 0 0 1 6.8 5.5H9Z" stroke="#1F2A37" stroke-width="2" />
              <path d="M12 17a4 4 0 1 0 0-8 4 4 0 0 0 0 8Z" stroke="#1F2A37" stroke-width="2" />
            </svg>
          </div>
          <div class="title">
            <h1>VideoShot</h1>
            <p>Extract clear frames from your video</p>
          </div>
        </div>

        <button class="gear-btn" id="settingsBtn" type="button" title="Settings">
          <span aria-hidden="true">‚öôÔ∏è</span> Settings
        </button>
      </div>
    </div>

    <div class="wrap">
      <div class="grid">
        <div class="card">
          <div class="head">
            <span class="pill">üìº Upload a video</span>
            <span class="pill">üîí Runs in your browser</span>
          </div>

          <div class="content">
            <div class="drop">
              <div class="file-row">
                <label class="btn" for="fileInput">
                  <span aria-hidden="true">‚ûï</span> Choose video
                </label>
                <button class="btn secondary" id="clearBtn" type="button">
                  Remove
                </button>
                <input id="fileInput" type="file" accept="video/*" />
              </div>

              <div class="kv">
                <div class="box">
                  <div class="k">Video length</div>
                  <div class="v" id="lenVal">‚Äî</div>
                </div>
                <div class="box">
                  <div class="k">Shots selected</div>
                  <div class="v" id="shotsVal">‚Äî</div>
                </div>
              </div>

              <div class="settings" id="settingsPanel">
                <div class="row">
                  <label for="shotsRange">Requested shots</label>
                  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
                    <input id="shotsRange" type="range" min="5" max="10" value="10" />
                    <span class="pill" id="shotsRangeLabel">10</span>
                  </div>
                </div>
                <div class="hint" id="capHint">Max allowed is based on video length.</div>
              </div>

              <div class="status" id="statusBox" style="display:none;">
                <div class="dot" aria-hidden="true"></div>
                <div>
                  <div style="font-weight:950" id="statusTitle">Working‚Ä¶</div>
                  <div class="small" id="statusText">Preparing‚Ä¶</div>
                </div>
              </div>
            </div>

            <div class="results-head">
              <h2>Best Shots</h2>
              <div class="actions">
                <button class="btn secondary" id="previewAllBtn" type="button" disabled>
                  ‚ñ∂Ô∏è Preview All
                </button>
                <button class="btn secondary" id="downloadAllBtn" type="button" disabled>
                  ‚¨áÔ∏è Download All
                </button>
              </div>
            </div>

            <div class="gallery" id="gallery"></div>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <span class="pill">üéûÔ∏è Preview</span>
            <span class="pill">üß† Face-first when supported</span>
          </div>
          <div class="content">
            <video id="video" controls playsinline style="width:100%;border-radius:18px;border:3px solid rgba(0,0,0,0.06);background:#000"></video>

            <div class="status" style="margin-top:12px;">
              <div class="dot" aria-hidden="true" style="background:var(--blue); box-shadow:0 0 0 6px rgba(31,91,255,.18)"></div>
              <div>
                <div style="font-weight:950">Heads-up</div>
                <div class="small">If you refresh or leave, results are gone unless you download them.</div>
              </div>
            </div>

            <div class="status" style="margin-top:12px;">
              <div class="dot" aria-hidden="true" style="background:var(--red); box-shadow:0 0 0 6px rgba(228,61,48,.18)"></div>
              <div>
                <div style="font-weight:950">Watermark</div>
                <div class="small">Downloaded images use <b>logo.png</b> at the site root.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">¬© VideoShot</div>
    </div>

    <div class="modal" id="modal">
      <div class="panel">
        <div class="mhead">
          <h3>Preview</h3>
          <button class="btn danger" id="closeModal" type="button">‚úñ Close</button>
        </div>
        <div class="body">
          <div class="carousel" id="carousel"></div>
        </div>
      </div>
    </div>

    <script>
      const MIN_SHOTS = 5;
      const DEFAULT_UP_TO_60 = 10;

      const fileInput = document.getElementById('fileInput');
      const video = document.getElementById('video');
      const gallery = document.getElementById('gallery');
      const lenVal = document.getElementById('lenVal');
      const shotsVal = document.getElementById('shotsVal');

      const statusBox = document.getElementById('statusBox');
      const statusTitle = document.getElementById('statusTitle');
      const statusText = document.getElementById('statusText');

      const previewAllBtn = document.getElementById('previewAllBtn');
      const downloadAllBtn = document.getElementById('downloadAllBtn');
      const clearBtn = document.getElementById('clearBtn');

      const modal = document.getElementById('modal');
      const closeModal = document.getElementById('closeModal');
      const carousel = document.getElementById('carousel');

      const settingsBtn = document.getElementById('settingsBtn');
      const settingsPanel = document.getElementById('settingsPanel');
      const shotsRange = document.getElementById('shotsRange');
      const shotsRangeLabel = document.getElementById('shotsRangeLabel');
      const capHint = document.getElementById('capHint');

      let currentFile = null;
      let objectUrl = null;
      let lastFrames = [];

      const watermarkImg = new Image();
      watermarkImg.src = '/logo.png';

      function showStatus(title, text){
        statusBox.style.display = 'flex';
        statusTitle.textContent = title;
        statusText.textContent = text;
      }
      function hideStatus(){ statusBox.style.display = 'none'; }
      function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
      function ceil67pct(seconds){ return Math.ceil(seconds * 0.67); }

      function defaultShotsForDuration(seconds){
        if (seconds <= 30) return MIN_SHOTS;
        if (seconds <= 60) return DEFAULT_UP_TO_60;
        return Math.max(DEFAULT_UP_TO_60, Math.ceil(seconds / 6));
      }

      function makeSequencedName(i, t){
        const ms = Math.round(t * 1000);
        return `videoshot_${String(i+1).padStart(2,'0')}_${ms}ms.png`;
      }

      function downloadBlob(blob, filename){
        const a = document.createElement('a');
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 4000);
      }

      function sharpnessScore(ctx, w, h){
        const img = ctx.getImageData(0,0,w,h).data;
        let score = 0;
        const step = 4;
        for(let y=1; y<h-1; y+=step){
          for(let x=1; x<w-1; x+=step){
            const idx = (y*w + x) * 4;
            const lum = 0.2126*img[idx] + 0.7152*img[idx+1] + 0.0722*img[idx+2];
            const idxR = (y*w + (x+1)) * 4;
            const lumR = 0.2126*img[idxR] + 0.7152*img[idxR+1] + 0.0722*img[idxR+2];
            const idxD = ((y+1)*w + x) * 4;
            const lumD = 0.2126*img[idxD] + 0.7152*img[idxD+1] + 0.0722*img[idxD+2];
            score += Math.abs(lum - lumR) + Math.abs(lum - lumD);
          }
        }
        return score;
      }

      async function faceBonusFromCanvas(canvas){
        if (!('FaceDetector' in window)) return 0;
        try{
          const detector = new FaceDetector({fastMode:true, maxDetectedFaces: 3});
          const faces = await detector.detect(canvas);
          if (!faces || faces.length === 0) return 0;

          let bonus = 0;
          const cx = canvas.width/2, cy = canvas.height/2;
          for(const f of faces){
            const b = f.boundingBox;
            const area = b.width * b.height;
            const fx = b.x + b.width/2;
            const fy = b.y + b.height/2;
            const dist = Math.hypot(fx - cx, fy - cy) / Math.hypot(cx, cy);
            bonus += (area / (canvas.width*canvas.height)) * 200000 * (1 - dist);
          }
          return bonus;
        }catch(e){ return 0; }
      }

      function computeSampleTimes(duration, desiredCount){
        const times = [];
        if (duration <= 0) return times;
        const pad = duration * 0.02;
        const start = Math.min(pad, duration/10);
        const end = Math.max(duration - pad, duration*0.98);
        const span = Math.max(0.001, end - start);

        for(let i=0; i<desiredCount; i++){
          const t = start + (span * (i / Math.max(1, desiredCount-1)));
          times.push(clamp(t, 0, Math.max(0, duration - 0.001)));
        }
        return times;
      }

      function waitForEvent(el, evt){
        return new Promise(res => {
          const handler = ()=>{ el.removeEventListener(evt, handler); res(); };
          el.addEventListener(evt, handler, {once:true});
        });
      }

      async function seekTo(t){
        video.currentTime = t;
        await waitForEvent(video, 'seeked');
      }

      async function captureAtTime(t, captureW=640){
        await seekTo(t);

        const vw = video.videoWidth || 1280;
        const vh = video.videoHeight || 720;
        const w = Math.min(captureW, vw);
        const h = Math.round((vh / vw) * w);

        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d', {willReadFrequently:true});
        ctx.drawImage(video, 0, 0, w, h);

        const sharp = sharpnessScore(ctx, w, h);
        const faceBonus = await faceBonusFromCanvas(canvas);
        const score = sharp + faceBonus;

        const out = document.createElement('canvas');
        out.width = w;
        out.height = h;
        const octx = out.getContext('2d');
        octx.drawImage(canvas, 0, 0);

        const logoReady = watermarkImg.complete && watermarkImg.naturalWidth > 0;
        if (logoReady){
          const logoW = Math.round(w * 0.22);
          const logoH = Math.round(logoW * (watermarkImg.naturalHeight / watermarkImg.naturalWidth));
          const pad = Math.round(w * 0.025);

          octx.globalAlpha = 0.85;
          octx.fillStyle = 'rgba(255,255,255,0.40)';
          octx.fillRect(w - logoW - pad - 10, h - logoH - pad - 10, logoW + 20, logoH + 20);

          octx.globalAlpha = 0.95;
          octx.drawImage(watermarkImg, w - logoW - pad, h - logoH - pad, logoW, logoH);
          octx.globalAlpha = 1;
        }

        const blob = await new Promise(res => out.toBlob(res, 'image/png', 0.92));
        const url = URL.createObjectURL(blob);
        return { blob, url, score, t };
      }

      function clearResults(){
        for (const f of lastFrames){
          try{ URL.revokeObjectURL(f.url); }catch{}
        }
        lastFrames = [];
        gallery.innerHTML = '';
        carousel.innerHTML = '';
        previewAllBtn.disabled = true;
        downloadAllBtn.disabled = true;
        shotsVal.textContent = '‚Äî';
      }

      function renderResults(frames){
        gallery.innerHTML = '';
        carousel.innerHTML = '';

        frames.forEach((f, i) => {
          const card = document.createElement('div');
          card.className = 'shot';

          const img = document.createElement('img');
          img.src = f.url;
          img.alt = `Shot ${i+1}`;

          const meta = document.createElement('div');
          meta.className = 'meta';

          const left = document.createElement('div');
          left.innerHTML = `<div class="tag">#${i+1} <span class="small">‚Ä¢ ${(f.t).toFixed(2)}s</span></div>`;

          const right = document.createElement('div');
          const dl = document.createElement('button');
          dl.className = 'btn secondary';
          dl.type = 'button';
          dl.textContent = 'Download';
          dl.onclick = () => downloadBlob(f.blob, f.name);

          right.appendChild(dl);
          meta.appendChild(left);
          meta.appendChild(right);

          card.appendChild(img);
          card.appendChild(meta);
          gallery.appendChild(card);

          const item = document.createElement('div');
          item.className = 'item';
          const cimg = document.createElement('img');
          cimg.src = f.url;
          cimg.alt = `Shot ${i+1}`;
          item.appendChild(cimg);
          carousel.appendChild(item);
        });

        previewAllBtn.disabled = frames.length === 0;
        downloadAllBtn.disabled = frames.length === 0;
        shotsVal.textContent = String(frames.length);
      }

      async function downloadAllZip(frames){
        if (!window.JSZip){
          frames.forEach(f => downloadBlob(f.blob, f.name));
          return;
        }
        const zip = new JSZip();
        const folder = zip.folder('videoshot_frames');
        for (const f of frames){
          folder.file(f.name, f.blob);
        }
        const content = await zip.generateAsync({type:'blob'});
        downloadBlob(content, 'videoshot_frames.zip');
      }

      function updateSettingsUI(duration){
        const cap = Math.max(MIN_SHOTS, ceil67pct(duration));
        const def = clamp(defaultShotsForDuration(duration), MIN_SHOTS, cap);

        shotsRange.min = String(MIN_SHOTS);
        shotsRange.max = String(cap);
        shotsRange.value = String(def);
        shotsRangeLabel.textContent = String(def);

        capHint.textContent = `Max allowed: ${cap} (67% of ${Math.ceil(duration)} seconds).`;
      }

      async function analyzeVideo(){
        clearResults();
        if (!currentFile) return;

        showStatus('Working‚Ä¶', 'Reading video‚Ä¶');
        await waitForEvent(video, 'loadedmetadata');

        const duration = video.duration;
        const dur = (isFinite(duration) && duration > 0) ? duration : 0;
        lenVal.textContent = dur ? `${dur.toFixed(2)}s` : '‚Äî';

        updateSettingsUI(dur || 1);

        const cap = Math.max(MIN_SHOTS, ceil67pct(dur || 1));
        const requested = clamp(parseInt(shotsRange.value, 10) || DEFAULT_UP_TO_60, MIN_SHOTS, cap);

        const candidatesWanted = clamp(Math.max(requested * 3, 18), 18, 140);
        const times = computeSampleTimes(dur || 1, candidatesWanted);

        const minimum = MIN_SHOTS;
        const desiredFinal = clamp(requested, minimum, cap);

        showStatus('Working‚Ä¶', `Scanning ${times.length} moments‚Ä¶`);

        try{ await video.play(); video.pause(); }catch{}

        const captured = [];
        for (let i=0; i<times.length; i++){
          showStatus('Working‚Ä¶', `Scanning ${i+1}/${times.length}‚Ä¶`);
          try{
            const item = await captureAtTime(times[i], 720);
            captured.push(item);
          }catch{}
        }

        if (captured.length < minimum){
          const fallbackTimes = computeSampleTimes(Math.max(dur, 0.2), minimum);
          for (let i=0; i<fallbackTimes.length && captured.length < minimum; i++){
            try{
              const item = await captureAtTime(fallbackTimes[i], 720);
              captured.push(item);
            }catch{}
          }
        }

        captured.sort((a,b)=>b.score - a.score);

        const picked = [];
        const minGap = Math.max(0.18, (dur || 1) / (desiredFinal * 2));
        for (const c of captured){
          if (picked.length >= desiredFinal) break;
          if (picked.every(p => Math.abs(p.t - c.t) >= minGap)){
            picked.push(c);
          }
        }
        for (const c of captured){
          if (picked.length >= desiredFinal) break;
          if (!picked.includes(c)) picked.push(c);
        }
        while (picked.length < minimum && captured.length){
          picked.push(captured[Math.min(picked.length, captured.length-1)]);
        }

        const finalFrames = picked.slice(0, Math.max(minimum, desiredFinal)).map((f, i)=>({
          ...f,
          name: makeSequencedName(i, f.t || 0)
        }));

        lastFrames = finalFrames;
        renderResults(lastFrames);

        showStatus('Done', `Prepared ${lastFrames.length} shots.`);
        setTimeout(hideStatus, 900);
      }

      settingsBtn.addEventListener('click', ()=>{
        settingsPanel.classList.toggle('open');
      });

      shotsRange.addEventListener('input', ()=>{
        shotsRangeLabel.textContent = shotsRange.value;
      });

      shotsRange.addEventListener('change', ()=>{
        if (currentFile) analyzeVideo();
      });

      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if (!f) return;

        currentFile = f;
        clearResults();

        if (objectUrl) URL.revokeObjectURL(objectUrl);
        objectUrl = URL.createObjectURL(f);
        video.src = objectUrl;

        showStatus('Working‚Ä¶', 'Loading video‚Ä¶');
      });

      video.addEventListener('loadedmetadata', ()=>{
        if (!currentFile) return;
        const dur = video.duration;
        lenVal.textContent = isFinite(dur) ? `${dur.toFixed(2)}s` : '‚Äî';
        updateSettingsUI(isFinite(dur) ? dur : 1);
        analyzeVideo();
      });

      clearBtn.addEventListener('click', ()=>{
        currentFile = null;
        fileInput.value = '';
        clearResults();
        lenVal.textContent = '‚Äî';
        if (objectUrl) URL.revokeObjectURL(objectUrl);
        objectUrl = null;
        video.removeAttribute('src');
        video.load();
        hideStatus();
      });

      previewAllBtn.addEventListener('click', ()=>{
        if (!lastFrames.length) return;
        modal.classList.add('open');
      });

      closeModal.addEventListener('click', ()=>{
        modal.classList.remove('open');
      });

      modal.addEventListener('click', (e)=>{
        if (e.target === modal) modal.classList.remove('open');
      });

      downloadAllBtn.addEventListener('click', async ()=>{
        if (!lastFrames.length) return;
        await downloadAllZip(lastFrames);
      });
    </script>
  </body>
</html>
